name: Provision
on:
  repository_dispatch:
    types: [ provision-command ]
jobs:
  help:
    runs-on: ubuntu-latest
    steps:
      - name: âš™ï¸ Configure GitHub Actions
        uses: actions/checkout@v3
        with:
          fetch-depth: '0'

      - name: âš™ï¸ Configure Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: âœï¸ Branch name
        uses: actions/github-script@v6
        id: branch
        env:
          ISSUE: ${{ toJson(github.event.client_payload.github.payload.issue) }}
        with:
          script: |
            const issue = JSON.parse(process.env.ISSUE);
            const kebabCase = string => string.replace(/([a-z])([A-Z])/g, '$1-$2').replace(/\s+/g, '-').toLowerCase()
            const feature = kebabCase(issue.title)
            const label = issue.labels.find(({name}) => name === 'feat' || name === 'refactor' || name === 'fix')
            return {
              branch: `${label.name}/issue-${issue.number}/${feature}`,
              feature
            }

      - name: ğŸ›  Create branch
        uses: peterjgrainger/action-create-branch@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: ${{ fromJSON(steps.branch.outputs.result).branch }}

      - name: ğŸ›  Initialize Terraform
        working-directory: ./aws
        run: terraform init

      - name: ğŸ— Provision Infrastructure
        id: terraform_plan
        working-directory: ./aws
        run: |
          terraform plan \
          -var="env_branch=${{ fromJSON(steps.branch.outputs.result).branch }}" \
          -var="env_prefix_domain=${{ fromJSON(steps.branch.outputs.result).feature }}"

      - name: ğŸ¤– Bot comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reaction-type: rocket
          body: |
            #### ğŸ— Provisioned infrastructure on **${{ github.event.client_payload.slash_command.args.named.env }}**
            - ğŸš§ Plan finished ${{ steps.terraform_plan.outcome }}
            
            <details>
              <summary>
            
              #### ğŸ“– Summary
              </summary>
            
              ${{ steps.terraform_plan.outputs.stdout }}
            </details>
